<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Buscar Recetas</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<!-- Header -->
<div th:replace="~{fragmentos :: header}"></div>

<div class="container my-5">
	<h1 class="mb-3">Buscar Recetas</h1>

	<div class="row">
		<div class="col-lg-8">
			<form id="search-form" class="card p-3 mb-4">
				<div class="mb-3">
					<label for="search-name" class="form-label">Nombre de la receta</label>
					<input id="search-name" class="form-control" placeholder="Ej: ensalada, sopa...">
				</div>

			<div class="mb-3">
				<label class="form-label">Precio máximo (soles)</label>
				<div class="d-flex align-items-center gap-2">
					<input id="price-slider" type="range" min="0" max="300" value="300" class="form-range">
					<input id="price-input" type="number" min="0" max="300" value="300" class="form-control" style="width: 80px;">
				</div>
				<small class="text-muted">Rango: S/ 0 - S/ 300</small>
			</div>				<div class="d-flex justify-content-end">
					<button type="submit" class="btn btn-success me-2">Buscar</button>
					<button type="button" id="clear-btn" class="btn btn-outline-secondary">Limpiar</button>
				</div>
			</form>

			<section>
				<h5 class="mb-3">Resultados</h5>
				<div id="results" class="row row-cols-1 row-cols-md-2 g-3"></div>
				<p id="no-results" class="text-muted mt-3" style="display:none">No se encontraron recetas.</p>
			</section>
		</div>

		<div class="col-lg-4">
			<div class="card p-3 mb-4">
				<h5>Filtrar por ingredientes</h5>
				<div id="ingredients-list" style="max-height:60vh; overflow:auto"></div>
			</div>
		</div>
	</div>
</div>

<!-- Footer -->
<div th:replace="~{fragmentos :: footer}"></div>
<!-- Scripts -->
<div th:replace="~{fragmentos :: scripts}"></div>
<script>
	const API_RECIPES = '/api/recetas';
	const API_INGREDIENTS = '/api/ingredientes';

	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('search-form');
		const nameInput = document.getElementById('search-name');
		const priceSlider = document.getElementById('price-slider');
		const priceInput = document.getElementById('price-input');
		const ingredientsList = document.getElementById('ingredients-list');
		const resultsEl = document.getElementById('results');
		const noResults = document.getElementById('no-results');
		const clearBtn = document.getElementById('clear-btn');

		// Sincronizar slider e input
		priceSlider.addEventListener('input', () => {
			priceInput.value = priceSlider.value;
		});

		priceInput.addEventListener('input', () => {
			let val = parseInt(priceInput.value) || 0;
			if (val < 0) val = 0;
			if (val > 300) val = 300;
			priceInput.value = val;
			priceSlider.value = val;
		});

		async function loadIngredients() {
			try {
				const res = await fetch(API_INGREDIENTS);
				if (!res.ok) throw new Error('No se pudo cargar ingredientes');
				const list = await res.json();
				ingredientsList.innerHTML = '';
				list.forEach(ing => {
					const id = ing.id;
					const name = ing.nombre;
					const div = document.createElement('div');
					div.className = 'form-check';
					const cb = document.createElement('input');
					cb.type = 'checkbox'; cb.className = 'form-check-input ingredient-check'; cb.id = 'ing-' + id; cb.dataset.id = id;
					const label = document.createElement('label'); label.className = 'form-check-label ms-2'; label.htmlFor = cb.id; label.textContent = name;
					div.appendChild(cb); div.appendChild(label);
					ingredientsList.appendChild(div);
				});
			} catch (err) {
				console.error(err);
				ingredientsList.innerHTML = '<p class="text-muted">No se pudieron cargar ingredientes.</p>';
			}
		}

		function getSelectedIngredientIds() {
			const checks = document.querySelectorAll('.ingredient-check:checked');
			return Array.from(checks).map(c => parseInt(c.dataset.id));
		}

		async function doSearch(e) {
			if (e) e.preventDefault();
			resultsEl.innerHTML = '';
			noResults.style.display = 'none';

			const nombre = nameInput.value.trim();
			const maxPrecio = parseInt(priceInput.value) || 300;
			const ingredientes = getSelectedIngredientIds();

			const params = new URLSearchParams();
			if (nombre) params.append('nombre', nombre);
			if (maxPrecio !== undefined) params.append('maxPrecio', maxPrecio);
			ingredientes.forEach(id => params.append('ingredienteId', id));

			try {
				const res = await fetch(`${API_RECIPES}/buscar?${params.toString()}`);
				if (!res.ok) throw new Error('Error en búsqueda');
				const recipes = await res.json();
				if (!recipes || recipes.length === 0) {
					noResults.style.display = 'block';
					return;
				}

				recipes.forEach(r => {
					const col = document.createElement('div'); col.className = 'col';
					const card = document.createElement('div'); card.className = 'card h-100';
					const img = document.createElement('img'); img.className = 'card-img-top'; img.style.height = '180px'; img.style.objectFit = 'cover'; img.src = r.imagenUrl || '/assets/recetas/default.jpg'; img.alt = r.nombre || '';
					const bd = document.createElement('div'); bd.className = 'card-body';
					const h5 = document.createElement('h5'); h5.className = 'card-title'; h5.textContent = r.nombre || '';
					const p = document.createElement('p'); p.className = 'card-text'; p.textContent = r.descripcion || '';
					bd.appendChild(h5); bd.appendChild(p);
					const ff = document.createElement('div'); ff.className = 'card-footer bg-white border-0';
					const btn = document.createElement('button'); btn.className = 'btn btn-sm btn-success w-100'; btn.textContent = 'Ver Receta'; btn.addEventListener('click', () => showDetail(r.id));
					ff.appendChild(btn);
					card.appendChild(img); card.appendChild(bd); card.appendChild(ff); col.appendChild(card); resultsEl.appendChild(col);
				});
			} catch (err) {
				console.error(err);
				noResults.style.display = 'block';
				noResults.textContent = 'Error al realizar la búsqueda.';
			}
		}

		function showDetail(id) {
			fetch(`${API_RECIPES}/${id}`).then(r => r.json()).then(data => {
				alert((data.nombre || 'Receta') + '\n\n' + (data.instrucciones || 'Sin instrucciones'));
			}).catch(err => console.error(err));
		}

		clearBtn.addEventListener('click', () => {
			nameInput.value = '';
			priceSlider.value = 300;
			priceInput.value = 300;
			document.querySelectorAll('.ingredient-check').forEach(cb => cb.checked = false);
			resultsEl.innerHTML = '';
			noResults.style.display = 'none';
		});

		form.addEventListener('submit', doSearch);
		loadIngredients();
	});
</script>

</body>
</html>

